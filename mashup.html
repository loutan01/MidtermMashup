<!DOCTYPE html>

<html>
  <head>
    <title> Weather Mashup</title>
    <h1>Weather mashup</h1>

    <script>
      weatherByLocation = function(){
        var obj, aVar, splitter, splitter2, region, city
        obj = new XMLHttpRequest()
        obj.onreadystatechange = function(){

          if(obj.readyState == 4 && obj.status == 200){
            aVar = obj.responseXML
            splitter = aVar.getElementsByTagName("regionName")
            region = splitter[0].childNodes[0].data
            splitter2 = aVar.getElementsByTagName("city")
            city = splitter2[0].childNodes[0].data
            console.log(city)
            console.log(region)

            weatherFromWolfram(region, city)
            imageOfLocation(region, city)
          }
        };

        obj.open("GET", "http://ip-api.com/xml/?fields=regionName,city", true);
        obj.send();
      }
      
      weatherOfInput = function(){
        var stringOfArea, area, city, region
        stringOfArea = document.getElementById("area").value;
        area = stringOfArea.split(", ");
        city = area.shift()
        region= area.toString()
        console.log(city)
        console.log(region)
        

        weatherFromWolfram(region, city)
        imageOfLocation(region, city)
      }

      weatherFromWolfram = function(region, city){
        var obj2, weather, node, replacedNode
        obj2 = new XMLHttpRequest()
        obj2.open("GET", "/getWeather/"+city+"/"+region, true);
        obj2.onreadystatechange = function(){
            if(obj2.readyState == 4 && obj2.status == 200){
              weather = document.createTextNode(obj2.responseText);
              node = document.getElementById("fromWolframQuery");
              replacedNode = document.getElementById("fromWolframQuery").childNodes[0];
              node.replaceChild(weather, replacedNode);
            }
        };

        obj2.send()
      }

      imageOfLocation = function(region, city){
        var obj3, query, aVar, img, replacedChild, node, newChild
        query = "\"" + city +" "+ region + "\""
        obj3 = new XMLHttpRequest()
           obj3.onreadystatechange = function(){
             if(obj3.readyState == 4 && obj3.status == 200){
              aVar = obj3.responseXML
              img = document.createElement("img")
              img.src = aVar.getElementsByTagName("photo")[0].getAttribute("url_o")
              replacedChild = document.getElementById("locationFromFlickr").childNodes[0];
              node = document.getElementById("locationFromFlickr")
              newChild = node.appendChild(img)
              node.replaceChild(newChild, replacedChild)
            }
        }
        obj3.open("GET", "https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=KEY GOES HERE&text=" + query + "&format=rest&extras=url_o", true)
        obj3.send()


      }
    </script>
  </head>
  <body>

  <div id = "infoIn">

    <input id = "area" type = "text" placeholder = "Enter City and Region separated by a comma" size = "50">

    <button onclick = "weatherOfInput()">Get weather now!</button>

    <button onclick = "weatherByLocation()">Get weather for my Location</button>
  </div>
  <div id = "wolframAlphaOutput">
    <p id = "fromWolframQuery">The weather goes here!</p>
  </div>
  <div id = "locationFromFlickr">
  </div>

  </body>

</html>
